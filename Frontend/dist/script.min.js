const API_URL="http://localhost:5000/api/produtos",gridInfo=document.getElementById("products-grid"),cartBtn=document.getElementById("cart-btn"),searchInput=document.getElementById("search-input"),searchBtn=document.getElementById("search-btn");let allProducts=[],currentSort="default";function getCarrinho(){return JSON.parse(localStorage.getItem("carrinho"))||[]}function saveCarrinho(e){localStorage.setItem("carrinho",JSON.stringify(e))}function getWishlist(){return JSON.parse(localStorage.getItem("wishlist"))||[]}function saveWishlist(e){localStorage.setItem("wishlist",JSON.stringify(e))}function getTheme(){return localStorage.getItem("theme")||"dark"}function saveTheme(e){localStorage.setItem("theme",e)}function initTheme(){const e=getTheme();document.documentElement.setAttribute("data-theme",e),updateThemeIcon()}function toggleTheme(){const e="dark"===getTheme()?"light":"dark";saveTheme(e),document.documentElement.setAttribute("data-theme",e),updateThemeIcon()}function updateThemeIcon(){const e=document.getElementById("theme-toggle");if(e){const t=e.querySelector("i");t&&(t.setAttribute("data-lucide","dark"===getTheme()?"sun":"moon"),"undefined"!=typeof lucide&&lucide.createIcons())}}function showSkeletons(e=6){gridInfo.innerHTML="";for(let t=0;t<e;t++){const e=document.createElement("article");e.className="product-card skeleton-card",e.innerHTML='\n            <div class="skeleton-image"></div>\n            <div class="skeleton-content">\n                <div class="skeleton-line short"></div>\n                <div class="skeleton-line"></div>\n                <div class="skeleton-line medium"></div>\n                <div class="skeleton-line short"></div>\n            </div>\n        ',e.style.animation=`fadeIn 0.3s ease ${.05*t}s backwards`,gridInfo.appendChild(e)}}async function loadProducts(){try{showSkeletons(6);const e=await fetch(API_URL);if(!e.ok)throw new Error(`Erro HTTP: ${e.status}`);allProducts=await e.json(),await new Promise(e=>setTimeout(e,500)),renderProducts(allProducts),atualizarCarrinhoUI(),setupFilters(),setupSearch(),setupSorting()}catch(e){console.error("Falha ao buscar produtos:",e),gridInfo.innerHTML=`\n            <div class="error">\n                <p>‚ö†Ô∏è N√£o foi poss√≠vel carregar o cat√°logo.</p>\n                <small>${e.message}</small>\n            </div>\n        `}}function renderProducts(e){if(gridInfo.innerHTML="",0===e.length)return void(gridInfo.innerHTML='<div class="loading">Nenhum produto encontrado.</div>');const t=getWishlist();e.forEach((e,o)=>{const n=document.createElement("article");n.className="product-card",n.style.opacity="0",n.style.animation=`fadeInUp 0.5s ease-out ${.06*o}s forwards`;const a=new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(e.preco),s=new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(e.preco/12),r=e.imagemUrl||`https://placehold.co/400x300/1e1e1e/ff9900?text=${encodeURIComponent(e.nome)}`,c=e.id>=8,i=Math.random()>.2;let d="";d=c?'<span class="badge new">Novo!</span>':i?'<span class="badge in-stock">Em estoque</span>':'<span class="badge low-stock">√öltimas unidades</span>';const l=t.includes(e.id),u=l?"heart-btn active":"heart-btn",m=getProductRating(e.id),p=getReviewCount(e.id);n.innerHTML=`\n            <button class="${u}" onclick="toggleWishlist(${e.id})" title="Adicionar aos favoritos">\n                ${l?"‚ù§Ô∏è":"ü§ç"}\n            </button>\n            <a href="produto.html?id=${e.id}" class="card-link">\n                <div class="card-image">\n                    ${d}\n                    <img src="${r}" alt="${e.nome}" loading="lazy">\n                    <button class="quick-view-btn" onclick="event.preventDefault(); openQuickView(${e.id})">üëÅÔ∏è Visualiza√ß√£o R√°pida</button>\n                </div>\n            </a>\n            <div class="card-content">\n                <div class="product-category">${e.categoria}</div>\n                <h3 class="product-title">\n                    <a href="produto.html?id=${e.id}">${e.nome}</a>\n                </h3>\n                <div class="product-rating">${generateStars(m)} <span>(${p})</span></div>\n                <p class="product-specs">${e.descricao||""}</p>\n                <div class="product-price">${a}</div>\n                <div class="product-installments">ou 12x de ${s}</div>\n                <button class="btn-buy" onclick="adicionarAoCarrinho(${JSON.stringify(e).replace(/"/g,"&quot;")})">\n                    <span>Adicionar ao Carrinho</span>\n                </button>\n            </div>\n        `,gridInfo.appendChild(n)})}function toggleWishlist(e){let t=getWishlist();t.includes(e)?(t=t.filter(t=>t!==e),showToast("Removido dos favoritos")):(t.push(e),showToast("Adicionado aos favoritos! ‚ù§Ô∏è")),saveWishlist(t),renderProducts(getSortedProducts())}function setupSorting(){const e=document.getElementById("sort-select");e&&e.addEventListener("change",e=>{currentSort=e.target.value,renderProducts(getSortedProducts())})}function getSortedProducts(){let e=[...allProducts];const t=document.querySelector(".filter-btn.active");if(t&&"all"!==t.dataset.category&&(e=e.filter(e=>e.categoria===t.dataset.category)),searchInput&&searchInput.value.trim()){const t=searchInput.value.toLowerCase().trim();e=e.filter(e=>e.nome.toLowerCase().includes(t)||e.categoria.toLowerCase().includes(t))}switch(currentSort){case"price-asc":e.sort((e,t)=>e.preco-t.preco);break;case"price-desc":e.sort((e,t)=>t.preco-e.preco);break;case"name-asc":e.sort((e,t)=>e.nome.localeCompare(t.nome));break;case"name-desc":e.sort((e,t)=>t.nome.localeCompare(e.nome))}return e}function setupFilters(){const e=document.querySelectorAll(".filter-btn");e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("active")),t.classList.add("active"),renderProducts(getSortedProducts())})})}function filterByCategory(e){document.querySelectorAll(".filter-btn").forEach(t=>{t.classList.remove("active"),t.dataset.category===e&&t.classList.add("active")}),renderProducts(getSortedProducts())}function setupSearch(){searchInput&&searchBtn&&(searchBtn.addEventListener("click",()=>renderProducts(getSortedProducts())),searchInput.addEventListener("keypress",e=>{"Enter"===e.key&&renderProducts(getSortedProducts())}),searchInput.addEventListener("input",()=>{""===searchInput.value&&renderProducts(getSortedProducts())}))}function adicionarAoCarrinho(e){const t=getCarrinho();t.push(e),saveCarrinho(t),atualizarCarrinhoUI(),showToast(`${e.nome} adicionado ao carrinho!`),animateCartBadge(),saveRecentlyViewed(e.id)}function atualizarCarrinhoUI(){const e=getCarrinho();cartBtn&&(cartBtn.innerHTML=`Carrinho <span class="cart-badge">${e.length}</span>`)}function animateCartBadge(){const e=document.querySelector(".cart-badge");e&&(e.classList.add("bounce"),setTimeout(()=>e.classList.remove("bounce"),500))}function showToast(e){const t=document.querySelector(".toast");t&&t.remove();const o=document.createElement("div");o.className="toast",o.textContent=e,document.body.appendChild(o),setTimeout(()=>o.classList.add("show"),10),setTimeout(()=>{o.classList.remove("show"),setTimeout(()=>o.remove(),300)},3e3)}let compareList=[];function toggleCompare(e){if(compareList.includes(e))compareList=compareList.filter(t=>t!==e),showToast("Removido da compara√ß√£o");else{if(compareList.length>=3)return void showToast("M√°ximo 3 produtos para comparar!");compareList.push(e),showToast("Adicionado √† compara√ß√£o")}updateCompareUI(),renderProducts(getSortedProducts())}function updateCompareUI(){const e=document.getElementById("compare-bar");e&&(compareList.length>0?(e.classList.add("show"),e.querySelector(".compare-count").textContent=compareList.length):e.classList.remove("show"))}function openCompareModal(){if(compareList.length<2)return void showToast("Selecione pelo menos 2 produtos");const e=compareList.map(e=>allProducts.find(t=>t.id===e)),t=document.createElement("div");t.className="modal-overlay",t.innerHTML=`\n        <div class="modal compare-modal">\n            <button class="modal-close" onclick="closeModal(this)">&times;</button>\n            <h2>Comparar Produtos</h2>\n            <div class="compare-grid">\n                ${e.map(e=>`\n                    <div class="compare-item">\n                        <img src="${e.imagemUrl}" alt="${e.nome}">\n                        <h3>${e.nome}</h3>\n                        <div class="compare-price">${formatPrice(e.preco)}</div>\n                        <div class="compare-specs">${e.descricao||""}</div>\n                        <button class="btn-buy" onclick="adicionarAoCarrinho(${JSON.stringify(e).replace(/"/g,"&quot;")}); closeModal(this.closest('.modal-overlay'))">\n                            Adicionar\n                        </button>\n                    </div>\n                `).join("")}\n            </div>\n        </div>\n    `,document.body.appendChild(t),setTimeout(()=>t.classList.add("show"),10)}function clearCompare(){compareList=[],updateCompareUI(),renderProducts(getSortedProducts()),showToast("Compara√ß√£o limpa")}function openQuickView(e){const t=allProducts.find(t=>t.id===e);if(!t)return;saveRecentlyViewed(e);const o=document.createElement("div");o.className="modal-overlay",o.innerHTML=`\n        <div class="modal quick-view-modal">\n            <button class="modal-close" onclick="closeModal(this)">&times;</button>\n            <div class="quick-view-content">\n                <div class="quick-view-image">\n                    <img src="${t.imagemUrl}" alt="${t.nome}">\n                </div>\n                <div class="quick-view-info">\n                    <span class="product-category">${t.categoria}</span>\n                    <h2>${t.nome}</h2>\n                    <div class="quick-view-rating">\n                        ${generateStars(getProductRating(e))}\n                        <span>(${getReviewCount(e)} avalia√ß√µes)</span>\n                    </div>\n                    <div class="quick-view-price">${formatPrice(t.preco)}</div>\n                    <div class="quick-view-installments">ou 12x de ${formatPrice(t.preco/12)}</div>\n                    <p class="quick-view-specs">${t.descricao||""}</p>\n                    <div class="quick-view-actions">\n                        <button class="btn-buy" onclick="adicionarAoCarrinho(${JSON.stringify(t).replace(/"/g,"&quot;")}); closeModal(this.closest('.modal-overlay'))">\n                            Adicionar ao Carrinho\n                        </button>\n                        <a href="produto.html?id=${t.id}" class="btn-details">Ver Detalhes</a>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `,document.body.appendChild(o),setTimeout(()=>o.classList.add("show"),10)}function closeModal(e){const t=e.closest(".modal-overlay");t.classList.remove("show"),setTimeout(()=>t.remove(),300)}function getProductRating(e){return(JSON.parse(localStorage.getItem("ratings"))||{})[e]||3.5+1.5*Math.random()}function getReviewCount(e){return Math.floor(10+90*Math.random())}function generateStars(e){const t=Math.floor(e),o=e%1>=.5?1:0,n=5-t-o;return"‚òÖ".repeat(t)+(o?"‚Ø®":"")+"‚òÜ".repeat(n)}function getRecentlyViewed(){return JSON.parse(localStorage.getItem("recentlyViewed"))||[]}function saveRecentlyViewed(e){let t=getRecentlyViewed();t=t.filter(t=>t!==e),t.unshift(e),t=t.slice(0,5),localStorage.setItem("recentlyViewed",JSON.stringify(t))}const VALID_COUPONS={CORESTAY10:.1,GAMER20:.2,HARDWARE15:.15};function applyCoupon(e){const t=VALID_COUPONS[e.toUpperCase()];return t?(localStorage.setItem("appliedCoupon",JSON.stringify({code:e.toUpperCase(),discount:t})),showToast(`Cupom ${e.toUpperCase()} aplicado! ${100*t}% OFF`),!0):(showToast("Cupom inv√°lido"),!1)}function getAppliedCoupon(){return JSON.parse(localStorage.getItem("appliedCoupon"))}function formatPrice(e){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(e)}function subscribeNewsletter(e){e.preventDefault();const t=document.getElementById("newsletter-email"),o=document.getElementById("newsletter-status"),n=t.value.trim();if(!n)return o.textContent="‚úó Digite um e-mail v√°lido",void(o.className="newsletter-status error");const a=JSON.parse(localStorage.getItem("newsletterSubscribers"))||[];if(a.includes(n))return o.textContent="‚úì E-mail j√° cadastrado!",void(o.className="newsletter-status success");a.push(n),localStorage.setItem("newsletterSubscribers",JSON.stringify(a)),o.textContent="‚úì Inscrito com sucesso! Obrigado!",o.className="newsletter-status success",t.value="",showToast("üéâ Inscrito na newsletter!")}window.filterByCategory=filterByCategory,window.toggleWishlist=toggleWishlist,window.toggleTheme=toggleTheme,window.toggleCompare=toggleCompare,window.openQuickView=openQuickView,window.openCompareModal=openCompareModal,window.clearCompare=clearCompare,window.closeModal=closeModal,window.applyCoupon=applyCoupon,document.addEventListener("DOMContentLoaded",()=>{initTheme(),loadProducts()});